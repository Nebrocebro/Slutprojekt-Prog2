<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="public/style.css">
    <style>
      canvas {
        border: 1px solid #000;
      }
    </style>
    <title>Move Circle</title>
  </head>
  <body>
    <nav>
      <!-- Lägg till action="/addUser" och method="post" när "spelet" är klart -->
      <form id="addUserForm" onsubmit="submitForm(event)" enctype="multipart/form-data" style="margin-top: 5px; margin-bottom: 5px;">
        <label for="username">* Username:</label>
        <input type="text" id="usernameinput" name="username" autocomplete="off" placeholder="Nickname" style="color: black;" required/><br>

        <label for="passwd">* Password:</label>
        <input type="password" id="passwd" name="passwd" style="color: #000;" required><br>
            
        <label for="profilePic">Profile Picture (Not required):</label>
        <input type="file" id="profilePic" name="profilePic"><br>

        <label for="circolor">Give your blob your favourite color! (Not required)</label>
        <input type="color" name="circolor" id="circolor" style="border-radius: 100%;"><br>

        <button type="submit" style="color: black;">Submit</button>
      </form>
      <button onclick="window.location.reload()" style="color: black; float: right; padding: 5px; border-radius: 15px;">Start Over</button>
    </nav>
    <br>
    <div id="maincontainer">
      <h1>Circle Mover!</h1>
      <canvas id="myCanvas" width="600" height="600"></canvas>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
      // Canvas
      const canvas = document.getElementById("myCanvas")
      const ctx = canvas.getContext("2d")

      const devicePixelRatio = window.devicePixelRatio || 1;

      canvas.width = canvas.width * devicePixelRatio;
      canvas.height = canvas.height * devicePixelRatio;

      ctx.scale(devicePixelRatio, devicePixelRatio);

      ctx.imageSmoothingEnabled = false;

      const socket = io()

      // Basdata för cirklarna
      let circleX = 50
      let circleY = 50
      const circleRadius = 20
      let circleColor = "blue"
      let username = "";
      const speed = 2;

      // Array för users data
      const users = {};

      const foods = [];

      const movement = {
        up: false,
        down: false,
        left: false,
        right: false
      };

      function getRandomInt(min, max) {
        const minCeiled = Math.ceil(min);
        const maxFloored = Math.floor(max);
        return Math.floor(Math.random() * (maxFloored - minCeiled) + minCeiled);
      }

      function Food(rad) {
        this.x = getRandomInt(20, canvas.width - 20);
        this.y = getRandomInt(20, canvas.height - 20);
        this.rad = rad;
        this.color = "green";
        this.username = "";
        this.show = function() {
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.rad, 0, 2 * Math.PI);
          ctx.fillStyle = this.color;
          ctx.fill(255);
          ctx.stroke();
        }
      }

      function startGame() {
        for (var j = 0; j < 10; j++) {
          foods[j] = new Food(5);

          // foods[j].x = getRandomInt(20, canvas.width - 20);
          // foods[j].y = getRandomInt(20, canvas.height - 20);
          // foods[j].color = "green";
          // foods[j].username = "";
        }
      }

      // Funktionen som ritar cirklarna
      function drawCircle(x, y, color, username) {
        ctx.beginPath();
        ctx.arc(x, y, circleRadius, 0, 2 * Math.PI);
        ctx.fillStyle = color;
        ctx.fill();
        ctx.stroke();

        ctx.font = '8px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = 'white'; // Set text color
        ctx.fillText(username, x, y);
      }

      //-----------

      // Funktionen som kallar alla users cirklar och ritar dem efter att ha clearat canvas
      function drawAllUsers() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (const userId in users) {
          const user = users[userId];
          drawCircle(user.x, user.y, user.color, user.username);
        }
        for (var i = 0; i < foods.length; i++) {
          foods[i].show();
        }
      }

      //------------

      // Key press listen-funktionen, keyUpdateInterval skapar en mjukare rörelse
      const keyUpdateInterval = 16;
      let keyUpdateTimer;

      function handleKeyPress(event) {
        switch (event.key) {
          case "ArrowUp":
          case "w":
            movement.up = true;
            break;
          case "ArrowDown":
          case "s":
            movement.down = true;
            break;
          case "ArrowLeft":
          case "a":
            movement.left = true;
            break;
          case "ArrowRight":
          case "d":
            movement.right = true;
            break;
        }

        if (!keyUpdateTimer) {
          keyUpdateTimer = setInterval(updatePosition, keyUpdateInterval);
        }
      }

      function handleKeyRelease(event) {
        switch (event.key) {
          case "ArrowUp":
          case "w":
            movement.up = false;
            break;
          case "ArrowDown":
          case "s":
            movement.down = false;
            break;
          case "ArrowLeft":
          case "a":
            movement.left = false;
            break;
          case "ArrowRight":
          case "d":
            movement.right = false;
            break;
        }

        // Clear the interval timer when no keys are pressed
        if (!movement.up && !movement.down && !movement.left && !movement.right) {
          clearInterval(keyUpdateTimer);
          keyUpdateTimer = null;
        }
      }


      function updatePosition() {
        let dx = 0;
        let dy = 0;

        if (movement.up) dy -= 1;
        if (movement.down) dy += 1;
        if (movement.left) dx -= 1;
        if (movement.right) dx += 1;

        if (dx !== 0 || dy !== 0) {
          circleX += dx * speed;
          circleY += dy * speed;

          drawCircle(circleX, circleY, circleColor);
          socket.emit("updatePosition", { id: socket.id, x: circleX, y: circleY, color: circleColor, username: username});
        }
      }

      // Sparar all användardata som inmatats i formuläret i början, och gömmer sedan formuläret
      function submitForm(event) {
        event.preventDefault();

        username = document.getElementById("usernameinput").value;
        const favColor = document.getElementById("circolor").value;
        circleColor = favColor;

        socket.emit("newUser", { username, color: circleColor, x: circleX, y: circleY });

        document.addEventListener("keydown", handleKeyPress);
        document.addEventListener("keyup", handleKeyRelease);
        document.getElementById("addUserForm").style.display = "none";
        drawAllUsers();
        startGame();
      }

      // Uppdaterar users cirklar med ny information
      socket.on("updateUsers", (updatedUsers) => {
        for (const userId in updatedUsers) {
          const updatedUser = updatedUsers[userId];
          users[userId] = { ...users[userId], ...updatedUser };
        }
        drawAllUsers();
        startGame();
      });

      // Uppdaterar positionen av flyttade cirkeln för alla users
      socket.on("updatePosition", (data) => {
        users[data.id] = data;
        drawAllUsers();
        startGame();
      });
    </script>
  </body>
</html>